<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinguaLog Local</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .st-header { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .sidebar { background-color: #f8f9fa; padding: 20px; border-radius: 8px; height: 100%; }
        .result-box { margin-bottom: 15px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; text-align: center; padding-top: 20%; }
    </style>
</head>
<body class="bg-light">

    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h3 class="mt-3">Loading local model & thinking...</h3>
    </div>

    <div class="container-fluid mt-4">
        <div class="row">
            
            <div class="col-md-3 mb-4">
                <div class="sidebar">
                    <h4>How it works</h4>
                    <ol>
                        <li><strong>Write</strong> text with mixed languages: <em>'Je veux une [apple].'</em></li>
                        <li><strong>Retriever</strong> looks up your past errors.</li>
                        <li><strong>LLMs</strong> translates & corrects you.</li>
                        <li><strong>Archivist</strong> saves new errors to memory.</li>
                    </ol>
                </div>
            </div>

            <div class="col-md-9">
                <div class="st-header">
                    <h1>üìò LinguaLog</h1>
                    <p class="text-muted">Your personal diary-writing tutor for the language learning.</p>
                    <p class="text-muted"><a href="{{ url_for('index') }}">diary viewer</a></p>
                </div>

                <div class="card p-4 shadow-sm mb-4">
                    <form method="POST" onsubmit="document.getElementById('loading').style.display='block'">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Write your diary entry:</label>
                            <textarea name="draft_text" class="form-control" rows="5" placeholder="Example: Je m‚Äôappelle Jessica...">{{ form.draft_text }}</textarea>
                            <small class="text-muted">Example: Je me appelle Jessica. Je suis [a girl], je suis fran√ßais...</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">diary title</label>
                            <input type="text" name="title_diary" class="form-control" placeholder="No name is okay.">
                        </div>


                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Diary Language (ISO 639-3)</label>
                                <input type="text" name="lang_diary_body" class="form-control" placeholder="fra" value="{{ form.lang_diary_body }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Annotation Language</label>
                                <input type="text" name="lang_annotation" class="form-control" placeholder="eng" value="{{ form.lang_annotation }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Rewriting Level</label>
                                <input type="text" name="level_rewriting" class="form-control" placeholder="B2" value="{{ form.level_rewriting }}">
                            </div>
                        </div>
                        
                            
                            <div class="accordion mb-4" id="configAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingConfig">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="false" aria-controls="collapseConfig">
                                        ‚öôÔ∏è Advanced Configuration
                                    </button>
                                </h2>
                                <div id="collapseConfig" class="accordion-collapse collapse" aria-labelledby="headingConfig" data-bs-parent="#configAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">config_translator</label>
                                                <div class="accordion-body">
                                                    <!-- <div class="form-check form-switch mb-2">
                                                        <input class="form-check-input" type="checkbox" name="config_translator[is_execute]" checked>
                                                        <label class="form-check-label">Execute Task</label >
                                                    </div> -->
                                                    <div class="form-check form-switch mb-2">
                                                        <input class="form-check-input" type="checkbox" name="config_translator[enable_thinking]">
                                                        <label class="form-check-label">Enable Thinking</label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label>Max Tokens</label>
                                                        <input type="number" class="form-control" name="config_translator[max_tokens]" value="512">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- ------------------ -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">config_archivist</label>
                                                <div class="accordion-body">
                                                    <!-- <div class="form-check form-switch mb-2">
                                                        <input class="form-check-input" type="checkbox" name="config_archivist[is_execute]" checked>
                                                        <label class="form-check-label">Execute Task</label>
                                                    </div> -->
                                                    <div class="form-check form-switch mb-2">
                                                        <input class="form-check-input" type="checkbox" name="config_archivist[enable_thinking]">
                                                        <label class="form-check-label">Enable Thinking</label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label>Max Tokens</label>
                                                        <input type="number" class="form-control" name="config_archivist[max_tokens]" value="512">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- ------------------------- -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">config_rewriter</label>
                                                <div class="accordion-body">
                                                    <div class="form-check form-switch mb-2">
                                                        <input class="form-check-input" type="checkbox" name="config_rewriter[is_execute]" checked>
                                                        <label class="form-check-label">Execute Task</label>
                                                    </div>
                                                    <div class="form-check form-switch mb-2">
                                                        <input class="form-check-input" type="checkbox" name="config_rewriter[enable_thinking]">
                                                        <label class="form-check-label">Enable Thinking</label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label>Max Tokens</label>
                                                        <input type="number" class="form-control" name="config_rewriter[max_tokens]" value="512">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- ------------------------- -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">config_reviewer</label>
                                                <div class="accordion-body">
                                                    <div class="form-check form-switch mb-2">
                                                        <input class="form-check-input" type="checkbox" name="config_reviewer[is_execute]" checked>
                                                        <label class="form-check-label">Execute Task</label>
                                                    </div>
                                                    <div class="form-check form-switch mb-2">
                                                        <input class="form-check-input" type="checkbox" name="config_reviewer[enable_thinking]">
                                                        <label class="form-check-label">Enable Thinking</label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label>Max Tokens</label>
                                                        <input type="number" class="form-control" name="config_reviewer[max_tokens]" value="512">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- ------------------------- -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        </div>

                        <button type="submit" class="btn btn-primary px-5">Analyze Entry</button>
                    </form>
                </div>

                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}

                {% if result %}
                <div class="row">
                    
                    <div class="col-md-6">
                        
                        <h5 class="mt-3">üìù Correction</h5>
                        <div class="alert alert-success">{{ result.final_response }}</div>

                        <h5 class="mt-3">üìù Suggestion ({{ form.level_rewriting }})</h5>
                        <div class="alert alert-success">{{ result.suggestion_response }}</div>

                        <h5 class="mt-3">‚ùì Unknown Expressions</h5>
                        {% for item in result.translation_pair_extracted %}
                            <div class="alert alert-success py-2">
                                <strong>[{{ item.expression_original }}]</strong> &rarr; {{ item.expression_translation }}
                            </div>
                        {% endfor %}

                        <h5 class="mt-3">Review Comments</h5>
                        <div class="alert alert-success">{{ result.total_review }}</div>
                    </div>

                    <div class="col-md-6">
                        
                        <h5 class="mt-3">üß† Memory Context</h5>
                        {% if result.retrieved_context != "None" %}
                            <div class="alert alert-info">
                                <strong>Recall:</strong><br>
                                {{ result.retrieved_context }}
                            </div>
                        {% else %}
                            <p class="text-muted">No relevant past errors found.</p>
                        {% endif %}

                        {% if result.grammatical_errors_extracted != "None" and result.grammatical_errors_extracted|length > 0 %}
                            <h5 class="mt-3">‚ö†Ô∏è New Learning Saved</h5>
                            {% for error in result.grammatical_errors_extracted %}
                                <div class="alert alert-warning">
                                    <strong>Category:</strong> {{ error.category }}<br>
                                    <strong>Rule:</strong> {{ error.error_rule }}<br>
                                    <hr class="my-1">
                                    <em>You wrote:</em> {{ error.example_phrase }}<br>
                                    <em>Correction:</em> {{ error.correction }}
                                </div>
                            {% endfor %}
                        {% endif %}

                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>